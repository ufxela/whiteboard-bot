#include "wbb-extra.h"
#include "math-helpers.h"

#define N_SIN_PTS 1024
#define MAX_SIN_VAL 0x10000
// generated from https://www.daycounter.com/Calculators/Sine-Generator-Calculator.phtml
// made 4x as dense w/ symmetry
unsigned sin_lookup[N_SIN_PTS*4] = {
    0x8000,0x8032,0x8064,0x8096,0x80c9,0x80fb,0x812d,0x815f,
    0x8192,0x81c4,0x81f6,0x8228,0x825b,0x828d,0x82bf,0x82f1,
    0x8324,0x8356,0x8388,0x83ba,0x83ed,0x841f,0x8451,0x8483,
    0x84b6,0x84e8,0x851a,0x854c,0x857e,0x85b1,0x85e3,0x8615,
    0x8647,0x867a,0x86ac,0x86de,0x8710,0x8742,0x8774,0x87a7,
    0x87d9,0x880b,0x883d,0x886f,0x88a1,0x88d4,0x8906,0x8938,
    0x896a,0x899c,0x89ce,0x8a00,0x8a32,0x8a65,0x8a97,0x8ac9,
    0x8afb,0x8b2d,0x8b5f,0x8b91,0x8bc3,0x8bf5,0x8c27,0x8c59,
    0x8c8b,0x8cbd,0x8cef,0x8d21,0x8d53,0x8d85,0x8db7,0x8de9,
    0x8e1b,0x8e4d,0x8e7f,0x8eb1,0x8ee3,0x8f15,0x8f47,0x8f79,
    0x8fab,0x8fdc,0x900e,0x9040,0x9072,0x90a4,0x90d6,0x9108,
    0x9139,0x916b,0x919d,0x91cf,0x9201,0x9232,0x9264,0x9296,
    0x92c7,0x92f9,0x932b,0x935d,0x938e,0x93c0,0x93f2,0x9423,
    0x9455,0x9487,0x94b8,0x94ea,0x951b,0x954d,0x957e,0x95b0,
    0x95e1,0x9613,0x9645,0x9676,0x96a7,0x96d9,0x970a,0x973c,
    0x976d,0x979f,0x97d0,0x9801,0x9833,0x9864,0x9895,0x98c7,
    0x98f8,0x9929,0x995b,0x998c,0x99bd,0x99ee,0x9a20,0x9a51,
    0x9a82,0x9ab3,0x9ae4,0x9b15,0x9b47,0x9b78,0x9ba9,0x9bda,
    0x9c0b,0x9c3c,0x9c6d,0x9c9e,0x9ccf,0x9d00,0x9d31,0x9d62,
    0x9d93,0x9dc4,0x9df4,0x9e25,0x9e56,0x9e87,0x9eb8,0x9ee9,
    0x9f19,0x9f4a,0x9f7b,0x9fac,0x9fdc,0xa00d,0xa03e,0xa06e,
    0xa09f,0xa0cf,0xa100,0xa131,0xa161,0xa192,0xa1c2,0xa1f3,
    0xa223,0xa253,0xa284,0xa2b4,0xa2e5,0xa315,0xa345,0xa376,
    0xa3a6,0xa3d6,0xa406,0xa437,0xa467,0xa497,0xa4c7,0xa4f7,
    0xa527,0xa557,0xa588,0xa5b8,0xa5e8,0xa618,0xa648,0xa678,
    0xa6a7,0xa6d7,0xa707,0xa737,0xa767,0xa797,0xa7c7,0xa7f6,
    0xa826,0xa856,0xa885,0xa8b5,0xa8e5,0xa914,0xa944,0xa974,
    0xa9a3,0xa9d3,0xaa02,0xaa32,0xaa61,0xaa90,0xaac0,0xaaef,
    0xab1f,0xab4e,0xab7d,0xabac,0xabdc,0xac0b,0xac3a,0xac69,
    0xac98,0xacc7,0xacf6,0xad26,0xad55,0xad84,0xadb3,0xade1,
    0xae10,0xae3f,0xae6e,0xae9d,0xaecc,0xaefa,0xaf29,0xaf58,
    0xaf87,0xafb5,0xafe4,0xb013,0xb041,0xb070,0xb09e,0xb0cd,
    0xb0fb,0xb12a,0xb158,0xb186,0xb1b5,0xb1e3,0xb211,0xb23f,
    0xb26e,0xb29c,0xb2ca,0xb2f8,0xb326,0xb354,0xb382,0xb3b0,
    0xb3de,0xb40c,0xb43a,0xb468,0xb496,0xb4c4,0xb4f1,0xb51f,
    0xb54d,0xb57b,0xb5a8,0xb5d6,0xb603,0xb631,0xb65e,0xb68c,
    0xb6b9,0xb6e7,0xb714,0xb742,0xb76f,0xb79c,0xb7c9,0xb7f7,
    0xb824,0xb851,0xb87e,0xb8ab,0xb8d8,0xb905,0xb932,0xb95f,
    0xb98c,0xb9b9,0xb9e6,0xba13,0xba3f,0xba6c,0xba99,0xbac6,
    0xbaf2,0xbb1f,0xbb4b,0xbb78,0xbba4,0xbbd1,0xbbfd,0xbc2a,
    0xbc56,0xbc82,0xbcaf,0xbcdb,0xbd07,0xbd33,0xbd5f,0xbd8b,
    0xbdb7,0xbde3,0xbe0f,0xbe3b,0xbe67,0xbe93,0xbebf,0xbeeb,
    0xbf17,0xbf42,0xbf6e,0xbf9a,0xbfc5,0xbff1,0xc01c,0xc048,
    0xc073,0xc09f,0xc0ca,0xc0f5,0xc121,0xc14c,0xc177,0xc1a2,
    0xc1cd,0xc1f8,0xc224,0xc24f,0xc279,0xc2a4,0xc2cf,0xc2fa,
    0xc325,0xc350,0xc37a,0xc3a5,0xc3d0,0xc3fa,0xc425,0xc450,
    0xc47a,0xc4a4,0xc4cf,0xc4f9,0xc524,0xc54e,0xc578,0xc5a2,
    0xc5cc,0xc5f7,0xc621,0xc64b,0xc675,0xc69f,0xc6c8,0xc6f2,
    0xc71c,0xc746,0xc770,0xc799,0xc7c3,0xc7ed,0xc816,0xc840,
    0xc869,0xc893,0xc8bc,0xc8e5,0xc90f,0xc938,0xc961,0xc98a,
    0xc9b3,0xc9dc,0xca05,0xca2e,0xca57,0xca80,0xcaa9,0xcad2,
    0xcafb,0xcb23,0xcb4c,0xcb75,0xcb9d,0xcbc6,0xcbee,0xcc17,
    0xcc3f,0xcc67,0xcc90,0xccb8,0xcce0,0xcd08,0xcd30,0xcd59,
    0xcd81,0xcda9,0xcdd0,0xcdf8,0xce20,0xce48,0xce70,0xce97,
    0xcebf,0xcee7,0xcf0e,0xcf36,0xcf5d,0xcf85,0xcfac,0xcfd3,
    0xcffb,0xd022,0xd049,0xd070,0xd097,0xd0be,0xd0e5,0xd10c,
    0xd133,0xd15a,0xd181,0xd1a7,0xd1ce,0xd1f5,0xd21b,0xd242,
    0xd268,0xd28f,0xd2b5,0xd2db,0xd302,0xd328,0xd34e,0xd374,
    0xd39a,0xd3c0,0xd3e6,0xd40c,0xd432,0xd458,0xd47e,0xd4a4,
    0xd4c9,0xd4ef,0xd514,0xd53a,0xd55f,0xd585,0xd5aa,0xd5d0,
    0xd5f5,0xd61a,0xd63f,0xd664,0xd689,0xd6ae,0xd6d3,0xd6f8,
    0xd71d,0xd742,0xd767,0xd78b,0xd7b0,0xd7d5,0xd7f9,0xd81e,
    0xd842,0xd866,0xd88b,0xd8af,0xd8d3,0xd8f7,0xd91b,0xd940,
    0xd964,0xd987,0xd9ab,0xd9cf,0xd9f3,0xda17,0xda3a,0xda5e,
    0xda82,0xdaa5,0xdac9,0xdaec,0xdb0f,0xdb33,0xdb56,0xdb79,
    0xdb9c,0xdbbf,0xdbe2,0xdc05,0xdc28,0xdc4b,0xdc6e,0xdc91,
    0xdcb3,0xdcd6,0xdcf8,0xdd1b,0xdd3d,0xdd60,0xdd82,0xdda5,
    0xddc7,0xdde9,0xde0b,0xde2d,0xde4f,0xde71,0xde93,0xdeb5,
    0xded7,0xdef8,0xdf1a,0xdf3c,0xdf5d,0xdf7f,0xdfa0,0xdfc2,
    0xdfe3,0xe004,0xe025,0xe046,0xe068,0xe089,0xe0aa,0xe0ca,
    0xe0eb,0xe10c,0xe12d,0xe14e,0xe16e,0xe18f,0xe1af,0xe1d0,
    0xe1f0,0xe210,0xe231,0xe251,0xe271,0xe291,0xe2b1,0xe2d1,
    0xe2f1,0xe311,0xe331,0xe351,0xe370,0xe390,0xe3af,0xe3cf,
    0xe3ee,0xe40e,0xe42d,0xe44c,0xe46b,0xe48b,0xe4aa,0xe4c9,
    0xe4e8,0xe507,0xe525,0xe544,0xe563,0xe582,0xe5a0,0xe5bf,
    0xe5dd,0xe5fb,0xe61a,0xe638,0xe656,0xe674,0xe693,0xe6b1,
    0xe6cf,0xe6ed,0xe70a,0xe728,0xe746,0xe764,0xe781,0xe79f,
    0xe7bc,0xe7da,0xe7f7,0xe814,0xe831,0xe84f,0xe86c,0xe889,
    0xe8a6,0xe8c3,0xe8df,0xe8fc,0xe919,0xe936,0xe952,0xe96f,
    0xe98b,0xe9a8,0xe9c4,0xe9e0,0xe9fc,0xea19,0xea35,0xea51,
    0xea6d,0xea89,0xeaa4,0xeac0,0xeadc,0xeaf8,0xeb13,0xeb2f,
    0xeb4a,0xeb65,0xeb81,0xeb9c,0xebb7,0xebd2,0xebed,0xec08,
    0xec23,0xec3e,0xec59,0xec74,0xec8e,0xeca9,0xecc3,0xecde,
    0xecf8,0xed13,0xed2d,0xed47,0xed61,0xed7b,0xed95,0xedaf,
    0xedc9,0xede3,0xedfd,0xee16,0xee30,0xee4a,0xee63,0xee7c,
    0xee96,0xeeaf,0xeec8,0xeee1,0xeefa,0xef13,0xef2c,0xef45,
    0xef5e,0xef77,0xef8f,0xefa8,0xefc1,0xefd9,0xeff2,0xf00a,
    0xf022,0xf03a,0xf052,0xf06b,0xf083,0xf09a,0xf0b2,0xf0ca,
    0xf0e2,0xf0fa,0xf111,0xf129,0xf140,0xf157,0xf16f,0xf186,
    0xf19d,0xf1b4,0xf1cb,0xf1e2,0xf1f9,0xf210,0xf227,0xf23e,
    0xf254,0xf26b,0xf281,0xf298,0xf2ae,0xf2c4,0xf2db,0xf2f1,
    0xf307,0xf31d,0xf333,0xf349,0xf35e,0xf374,0xf38a,0xf39f,
    0xf3b5,0xf3ca,0xf3e0,0xf3f5,0xf40a,0xf420,0xf435,0xf44a,
    0xf45f,0xf474,0xf488,0xf49d,0xf4b2,0xf4c6,0xf4db,0xf4ef,
    0xf504,0xf518,0xf52c,0xf541,0xf555,0xf569,0xf57d,0xf591,
    0xf5a5,0xf5b8,0xf5cc,0xf5e0,0xf5f3,0xf607,0xf61a,0xf62d,
    0xf641,0xf654,0xf667,0xf67a,0xf68d,0xf6a0,0xf6b3,0xf6c6,
    0xf6d8,0xf6eb,0xf6fe,0xf710,0xf722,0xf735,0xf747,0xf759,
    0xf76b,0xf77d,0xf78f,0xf7a1,0xf7b3,0xf7c5,0xf7d7,0xf7e8,
    0xf7fa,0xf80b,0xf81d,0xf82e,0xf83f,0xf850,0xf862,0xf873,
    0xf884,0xf894,0xf8a5,0xf8b6,0xf8c7,0xf8d7,0xf8e8,0xf8f8,
    0xf909,0xf919,0xf929,0xf939,0xf94a,0xf95a,0xf969,0xf979,
    0xf989,0xf999,0xf9a9,0xf9b8,0xf9c8,0xf9d7,0xf9e6,0xf9f6,
    0xfa05,0xfa14,0xfa23,0xfa32,0xfa41,0xfa50,0xfa5f,0xfa6d,
    0xfa7c,0xfa8b,0xfa99,0xfaa7,0xfab6,0xfac4,0xfad2,0xfae0,
    0xfaee,0xfafc,0xfb0a,0xfb18,0xfb26,0xfb33,0xfb41,0xfb4f,
    0xfb5c,0xfb69,0xfb77,0xfb84,0xfb91,0xfb9e,0xfbab,0xfbb8,
    0xfbc5,0xfbd2,0xfbde,0xfbeb,0xfbf8,0xfc04,0xfc10,0xfc1d,
    0xfc29,0xfc35,0xfc41,0xfc4d,0xfc59,0xfc65,0xfc71,0xfc7d,
    0xfc88,0xfc94,0xfc9f,0xfcab,0xfcb6,0xfcc1,0xfccd,0xfcd8,
    0xfce3,0xfcee,0xfcf9,0xfd04,0xfd0e,0xfd19,0xfd24,0xfd2e,
    0xfd39,0xfd43,0xfd4d,0xfd57,0xfd62,0xfd6c,0xfd76,0xfd80,
    0xfd89,0xfd93,0xfd9d,0xfda6,0xfdb0,0xfdb9,0xfdc3,0xfdcc,
    0xfdd5,0xfddf,0xfde8,0xfdf1,0xfdfa,0xfe02,0xfe0b,0xfe14,
    0xfe1d,0xfe25,0xfe2e,0xfe36,0xfe3e,0xfe47,0xfe4f,0xfe57,
    0xfe5f,0xfe67,0xfe6f,0xfe77,0xfe7e,0xfe86,0xfe8d,0xfe95,
    0xfe9c,0xfea4,0xfeab,0xfeb2,0xfeb9,0xfec0,0xfec7,0xfece,
    0xfed5,0xfedc,0xfee2,0xfee9,0xfeef,0xfef6,0xfefc,0xff02,
    0xff09,0xff0f,0xff15,0xff1b,0xff21,0xff26,0xff2c,0xff32,
    0xff37,0xff3d,0xff42,0xff48,0xff4d,0xff52,0xff57,0xff5c,
    0xff61,0xff66,0xff6b,0xff70,0xff74,0xff79,0xff7d,0xff82,
    0xff86,0xff8a,0xff8f,0xff93,0xff97,0xff9b,0xff9f,0xffa2,
    0xffa6,0xffaa,0xffad,0xffb1,0xffb4,0xffb8,0xffbb,0xffbe,
    0xffc1,0xffc4,0xffc7,0xffca,0xffcd,0xffd0,0xffd2,0xffd5,
    0xffd8,0xffda,0xffdc,0xffdf,0xffe1,0xffe3,0xffe5,0xffe7,
    0xffe9,0xffeb,0xffec,0xffee,0xfff0,0xfff1,0xfff3,0xfff4,
    0xfff5,0xfff6,0xfff7,0xfff8,0xfff9,0xfffa,0xfffb,0xfffc,
    0xfffd,0xfffd,0xfffe,0xfffe,0xfffe,0xffff,0xffff,0xffff,
};

unsigned wrapper(int index, unsigned mod){
    while(index < 0){
        index += mod;
    }
    while(index >= mod){
        index -= mod;
    }

    return index;
}

// max index is 1023 (1024 total). returns number between 0x0 and 0xffff, with 0x8000 being 0.
int sin(unsigned index){
    index = wrapper(index, N_SIN_PTS*4);
    if(index < N_SIN_PTS){
        return sin_lookup[index] - MAX_SIN_VAL/2;
    }else if(index < N_SIN_PTS * 2){
        return sin_lookup[2*N_SIN_PTS - index - 1]  - MAX_SIN_VAL/2;
    }else if(index < N_SIN_PTS * 3){
        return -1*(sin_lookup[index - 2*N_SIN_PTS] - MAX_SIN_VAL/2);
    }else{
        return -1 * (sin_lookup[4 * N_SIN_PTS - index - 1] - MAX_SIN_VAL/2);
    }
}

int cos(unsigned index){
    index = wrapper(N_SIN_PTS - index, N_SIN_PTS*4);
    if(index < N_SIN_PTS){
        return sin_lookup[index] - MAX_SIN_VAL/2;
    }else if(index < N_SIN_PTS * 2){
        return sin_lookup[2*N_SIN_PTS - index - 1]  - MAX_SIN_VAL/2;
    }else if(index < N_SIN_PTS * 3){
        return -1*(sin_lookup[index - 2*N_SIN_PTS] - MAX_SIN_VAL/2);
    }else{
        return -1 * (sin_lookup[4 * N_SIN_PTS - index - 1] - MAX_SIN_VAL/2);
    }
}

void wbb_draw_circle(wbb_t * wbb, unsigned radius, unsigned npoints){
    wbb_draw_arc(wbb, radius, npoints, 0, npoints + 1);
}

void wbb_draw_arc(wbb_t * wbb, unsigned radius, unsigned points_per_circ, int start_point, int end_point){
    coord_t start = wbb->curr_cartesian_pos;
    unsigned points = end_point - start_point;
	coord_t * arc_points = kmalloc(points * sizeof(coord_t));

    for(int i = start_point; i < end_point; i++){
        int point = divide(i * N_SIN_PTS*4, points_per_circ);
        int x_raw = radius * cos(point);
        int y_raw = radius * sin(point);
        if(x_raw < 0){
            x_raw = -1*divide(-1 * x_raw, MAX_SIN_VAL/2 - 1);
        }else{
            x_raw = divide(x_raw, MAX_SIN_VAL/2 - 1);
        }
        if(y_raw < 0){
            y_raw = -1*divide(-1 * y_raw, MAX_SIN_VAL/2 - 1);
        }else{
            y_raw = divide(y_raw, MAX_SIN_VAL/2 - 1);
        }
        if(i == start_point){
            start.x -= x_raw;
            start.y -= y_raw;
        }
        int x = x_raw + start.x;
        int y = y_raw + start.y;
        arc_points[i - start_point] = (coord_t) {x, y};
    }

    wbb_go_to_points(wbb, arc_points, points);
}